---
  title: "Intra Class Correlation for Coefficient of Variation"
output: html_notebook
---

```{r}
source("utilities.R")
source("variables.R")
df <- readRDS(file = sensor_raw_file)
```

```{r}

df %>%
  filter(sensor == "SHT35") %>% 
  select(site,humidity,exp) %>%
  group_by(exp) %>%
  mutate(grouped_id = row_number()) %>%
  filter(exp!="") %>%
spread(exp, humidity) %>%
  ungroup() %>%
  select(-site,-grouped_id)->tmp


qqnorm(tmp$`RH55 T23C 05092019 No Enclosure`)
qqnorm(tmp$`RH75 T23C 05092019 No Enclosure`)
qqnorm(tmp$`RH80 T23C 05092019 No Enclosure`)
qqnorm(tmp$`RH85 T23C 05092019 No Enclosure`)
qqnorm(tmp$`RH90 T23C 05092019 No Enclosure`)



```

The readings obtained do not follow a normal distribution, so the calculations should be conducted on the median.

```{r}
df %>%
  filter(sensor == "SHT35") %>%
  group_by(exp, site) %>%
  summarise(temp = mean(temperature, na.rm = TRUE), 
            temp_med = median(temperature, na.rm = TRUE),
            temp_min = min(temperature, na.rm = TRUE), 
            temp_max = max(temperature, na.rm = TRUE),
            temp_sd = sd(temperature, na.rm = TRUE),
            rh = mean(humidity, na.rm = TRUE), 
            rh_med = median(humidity, na.rm = TRUE), 
            rh_min = min(humidity, na.rm = TRUE),
            rh_max = max(humidity, na.rm = TRUE),
            rh_sd = sd(humidity, na.rm= TRUE)) ->summary_rh_temp_site

summary_rh_temp_site %>%  
  select(site,rh_med,exp) %>%
spread(site, rh_med) %>%
  ungroup() %>%
  select(-exp)->tmp
head(tmp)
require(psych)
ICC(t(tmp),missing=FALSE)

```
https://www.sciencedirect.com/science/article/pii/S1556370716000158?via%3Dihub#f0005 
In that case we want ICC(3,k) two way, mixedd effect, k raters, consistency (or absolute agreement but that is not implemented)

It has an ICC-score of 0.96313504	 with a p-value of 2.627437e-06 and a 95% range of 0.846408632	0.99740506. So good to excellent reliability.



```{r}

df %>%
  filter(sensor == "SHT35") %>%
  group_by(exp) %>%
  filter(exp!="") %>%
  summarise(temp = mean(temperature, na.rm = TRUE), 
            temp_med = median(temperature, na.rm = TRUE),
            temp_min = min(temperature, na.rm = TRUE), 
            temp_max = max(temperature, na.rm = TRUE),
            temp_2sd = 2*sd(temperature, na.rm = TRUE),
            rh = mean(humidity, na.rm = TRUE), 
            rh_med = median(humidity, na.rm = TRUE), 
            rh_min = min(humidity, na.rm = TRUE),
            rh_max = max(humidity, na.rm = TRUE),
            rh_2sd = 2*sd(humidity, na.rm= TRUE)) ->summary_rh_temp

summary_rh_temp
```

Calculate the 95% confidence of the median using the Wilcox test.

```{r}
unique(df$exp)

tmp <- df %>%
  filter(exp ==  "RH55 T23C 05092019 No Enclosure" )
wilcox.test(tmp$humidity, alternative = "two.sided", correct=TRUE,conf.int = TRUE, conf.level = 0.95)

tmp <- df %>%
  filter(exp ==  "RH75 T23C 05092019 No Enclosure" )
wilcox.test(tmp$humidity, alternative = "two.sided", correct=TRUE,conf.int = TRUE, conf.level = 0.95)

tmp <- df %>%
  filter(exp ==  "RH80 T23C 05092019 No Enclosure" )
wilcox.test(tmp$humidity, alternative = "two.sided", correct=TRUE,conf.int = TRUE, conf.level = 0.95)

tmp <- df %>%
  filter(exp ==  "RH85 T23C 05092019 No Enclosure" )
wilcox.test(tmp$humidity, alternative = "two.sided", correct=TRUE,conf.int = TRUE, conf.level = 0.95)


tmp <- df %>%
  filter(exp ==  "RH90 T23C 05092019 No Enclosure" )
wilcox.test(tmp$humidity, alternative = "two.sided", correct=TRUE,conf.int = TRUE, conf.level = 0.95)
```

The values are very centered.


They are not really normal distributions... So need for non-parametric anova

```{r}

summary_rh_temp %>%
  select(site,rh,exp) %>%
  group_by(exp) %>%
  mutate(grouped_id = row_number()) %>%
  filter(exp!="") %>%
spread(exp, rh) %>%
  ungroup() %>%
  select(-grouped_id)->tmp
tmp
write.csv(tmp, file = "grouped_tmp.csv")



df %>%
  filter(sensor == "SHT35") %>% 
  select(site,humidity,exp) %>%
  group_by(exp) %>%
  mutate(grouped_id = row_number()) %>%
  filter(exp!="") %>%
spread(exp, humidity) %>%
  ungroup() %>%
  select(-grouped_id)->tmp
tmp
write.csv(tmp, file = "all_rh.csv")

unique(df$exp)
df %>%
  filter(sensor == "SHT35") %>% 
  select(site,humidity,exp,date) %>%
  filter(exp == "RH55 T23C 05092019 No Enclosure") %>%
spread(site, humidity) %>%
  ungroup() ->tmp
tmp
write.csv(tmp, file = "exp_1_rh_all.csv")

df %>%
  filter(sensor == "SHT35") %>% 
  select(site,humidity,exp,date) %>%
  filter(exp == "RH75 T23C 05092019 No Enclosure") %>%
spread(site, humidity) %>%
  ungroup() ->tmp
tmp
write.csv(tmp, file = "exp_2_rh_all.csv")

df %>%
  filter(sensor == "SHT35") %>% 
  select(site,humidity,exp,date) %>%
  filter(exp == "RH80 T23C 05092019 No Enclosure") %>%
spread(site, humidity) %>%
  ungroup() ->tmp
tmp
write.csv(tmp, file = "exp_3_rh_all.csv")

df %>%
  filter(sensor == "SHT35") %>% 
  select(site,humidity,exp,date) %>%
  filter(exp == "RH85 T23C 05092019 No Enclosure") %>%
spread(site, humidity) %>%
  ungroup() ->tmp
tmp
write.csv(tmp, file = "exp_4_rh_all.csv")

df %>%
  filter(sensor == "SHT35") %>% 
  select(site,humidity,exp,date) %>%
  filter(exp == "RH90 T23C 05092019 No Enclosure") %>%
spread(site, humidity) %>%
  ungroup() ->tmp
tmp
write.csv(tmp, file = "exp_5_rh_all.csv")



df %>%
  filter(sensor == "SHT35") %>% 
  select(site,humidity,exp,date) %>%
    filter(exp!="") %>%
  mutate(site_exp = paste0(exp,"_",site)) %>%
  select(-site,-exp) %>%
spread(site_exp, humidity) %>%
        group_by(date = make_datetime(year =  year(date), month = month(date), day = day(date),hour = hour(date), min=minute(date)))%>% 
    summarise_all(funs(round2(mean(., na.rm = TRUE),1)) )%>%
  ungroup() ->tmp

tmp

write.csv(tmp, file = "rh_all_exp_1min.csv")


df %>%
  filter(sensor == "SHT35") %>% 
  select(site,humidity,exp,date) %>%
  mutate(humidity = round2(humidity,2)) %>%
    filter(exp!="") %>%
  mutate(site_exp = paste0(exp,"_",site)) %>%
  select(-site,-exp) %>%
spread(site_exp, humidity) %>%
        group_by(date = make_datetime(year =  year(date), month = month(date), day = day(date),hour = hour(date), min=minute(date),sec = round2(second(date)/10,0)*10))%>% 
    summarise_all(funs(mean(., na.rm = TRUE)) )%>%
  ungroup() ->tmp

tmp

write.csv(tmp, file = "rh_all_exp_10sec.csv")

```

```{r}
tmp %>%
  select(2:5) ->tp

ICC(t(tp),missing=FALSE)

```